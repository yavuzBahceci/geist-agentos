# Workflow: Detect Project Profile

## Purpose

Main orchestrator that calls all detection functions, aggregates results into a unified project profile, calculates overall confidence score, and handles fallbacks for failed detections.

## Inputs

- Project root directory (current working directory)
- Optional: Existing `geist/config/project-profile.yml` (for incremental updates)

## Outputs

- `geist/config/project-profile.yml` - Unified project profile
- `geist/config/detected-profile.yml` - Raw detection results (cache)

---

## Workflow

### Step 1: Initialize Detection Environment

```bash
echo "ðŸ” Starting project detection..."

# Initialize variables
DETECTION_CONFIDENCE=0
DETECTIONS_RUN=0
DETECTIONS_SUCCESS=0

# Create config directory if needed
mkdir -p geist/config

# Initialize raw detection results
cat > geist/config/detected-profile.yml << 'INIT_EOF'
# Auto-detected project profile
# Generated by detect-project-profile workflow

detected_at: $(date -Iseconds)
INIT_EOF
```

### Step 2: Run Detection Workflows

Execute each detection workflow in sequence:

```bash
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  PROJECT DETECTION"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Track detection results
declare -A DETECTION_RESULTS
declare -A DETECTION_CONFIDENCE

# 1. Detect Tech Stack
echo "ðŸ”§ Detecting tech stack..."
{{workflows/detection/detect-tech-stack}}
DETECTIONS_RUN=$((DETECTIONS_RUN + 1))
if [ -n "$DETECTED_LANGUAGE" ]; then
    DETECTIONS_SUCCESS=$((DETECTIONS_SUCCESS + 1))
    echo "   âœ“ Language: $DETECTED_LANGUAGE"
    [ -n "$DETECTED_FRAMEWORK" ] && echo "   âœ“ Framework: $DETECTED_FRAMEWORK"
    [ -n "$DETECTED_DATABASE" ] && echo "   âœ“ Database: $DETECTED_DATABASE"
fi

# 2. Detect Commands
echo "âš™ï¸  Detecting build/test/lint commands..."
{{workflows/detection/detect-commands}}
DETECTIONS_RUN=$((DETECTIONS_RUN + 1))
if [ -n "$DETECTED_BUILD_CMD" ] || [ -n "$DETECTED_TEST_CMD" ]; then
    DETECTIONS_SUCCESS=$((DETECTIONS_SUCCESS + 1))
    [ -n "$DETECTED_BUILD_CMD" ] && echo "   âœ“ Build: $DETECTED_BUILD_CMD"
    [ -n "$DETECTED_TEST_CMD" ] && echo "   âœ“ Test: $DETECTED_TEST_CMD"
    [ -n "$DETECTED_LINT_CMD" ] && echo "   âœ“ Lint: $DETECTED_LINT_CMD"
fi

# 3. Detect Architecture
echo "ðŸ—ï¸  Analyzing project architecture..."
{{workflows/detection/detect-architecture}}
DETECTIONS_RUN=$((DETECTIONS_RUN + 1))
if [ -n "$DETECTED_PROJECT_TYPE" ]; then
    DETECTIONS_SUCCESS=$((DETECTIONS_SUCCESS + 1))
    echo "   âœ“ Type: $DETECTED_PROJECT_TYPE"
    echo "   âœ“ Size: $DETECTED_FILE_COUNT files, ~$DETECTED_LINE_COUNT lines"
    [ -n "$DETECTED_MODULES" ] && echo "   âœ“ Modules: $DETECTED_MODULES"
fi

# 4. Detect Security Level
echo "ðŸ”’ Checking security indicators..."
{{workflows/detection/detect-security-level}}
DETECTIONS_RUN=$((DETECTIONS_RUN + 1))
if [ -n "$DETECTED_SECURITY_LEVEL" ]; then
    DETECTIONS_SUCCESS=$((DETECTIONS_SUCCESS + 1))
    echo "   âœ“ Security Level: $DETECTED_SECURITY_LEVEL"
fi
```

### Step 3: Calculate Overall Confidence

```bash
# Calculate confidence score (0.0 - 1.0)
if [ $DETECTIONS_RUN -gt 0 ]; then
    DETECTION_CONFIDENCE=$(echo "scale=2; $DETECTIONS_SUCCESS / $DETECTIONS_RUN" | bc)
else
    DETECTION_CONFIDENCE="0.00"
fi

echo ""
echo "ðŸ“Š Detection confidence: ${DETECTION_CONFIDENCE} ($DETECTIONS_SUCCESS/$DETECTIONS_RUN successful)"
```

### Step 4: Apply Fallbacks for Failed Detections

```bash
# Fallback: Unknown language
if [ -z "$DETECTED_LANGUAGE" ]; then
    echo "âš ï¸  Could not detect language - will ask user"
    DETECTED_LANGUAGE="unknown"
    NEEDS_USER_INPUT_LANGUAGE=true
fi

# Fallback: Unknown project type
if [ -z "$DETECTED_PROJECT_TYPE" ]; then
    echo "âš ï¸  Could not detect project type - will ask user"
    DETECTED_PROJECT_TYPE="unknown"
    NEEDS_USER_INPUT_TYPE=true
fi

# Fallback: Commands not found
if [ -z "$DETECTED_BUILD_CMD" ] && [ -z "$DETECTED_TEST_CMD" ]; then
    echo "âš ï¸  Could not detect build/test commands - using language defaults"
    case "$DETECTED_LANGUAGE" in
        "javascript"|"typescript") 
            DETECTED_BUILD_CMD="npm run build"
            DETECTED_TEST_CMD="npm test"
            DETECTED_LINT_CMD="npm run lint"
            ;;
        "rust")
            DETECTED_BUILD_CMD="cargo build"
            DETECTED_TEST_CMD="cargo test"
            DETECTED_LINT_CMD="cargo clippy"
            ;;
        "python")
            DETECTED_TEST_CMD="pytest"
            DETECTED_LINT_CMD="flake8"
            ;;
        "go")
            DETECTED_BUILD_CMD="go build ./..."
            DETECTED_TEST_CMD="go test ./..."
            DETECTED_LINT_CMD="golangci-lint run"
            ;;
    esac
fi

# Fallback: Security level
if [ -z "$DETECTED_SECURITY_LEVEL" ]; then
    DETECTED_SECURITY_LEVEL="moderate"
fi
```

### Step 5: Generate Unified Profile

```bash
# Infer complexity from size
INFERRED_COMPLEXITY="simple"
if [ "$DETECTED_FILE_COUNT" -gt 500 ] 2>/dev/null; then
    INFERRED_COMPLEXITY="complex"
elif [ "$DETECTED_FILE_COUNT" -gt 100 ] 2>/dev/null; then
    INFERRED_COMPLEXITY="moderate"
fi

# Generate the profile YAML
cat > geist/config/project-profile.yml << PROFILE_EOF
# Project Profile
# Auto-generated by detect-project-profile workflow
# Review and modify as needed

gathered:
  project_type: ${DETECTED_PROJECT_TYPE:-unknown}
  tech_stack:
    language: ${DETECTED_LANGUAGE:-unknown}
    framework: ${DETECTED_FRAMEWORK:-}
    backend: ${DETECTED_BACKEND:-}
    database: ${DETECTED_DATABASE:-}
  size:
    lines: ${DETECTED_LINE_COUNT:-0}
    files: ${DETECTED_FILE_COUNT:-0}
    modules: ${DETECTED_MODULE_COUNT:-0}
  commands:
    build: "${DETECTED_BUILD_CMD:-}"
    test: "${DETECTED_TEST_CMD:-}"
    lint: "${DETECTED_LINT_CMD:-}"

inferred:
  security_level: ${DETECTED_SECURITY_LEVEL:-moderate}
  complexity: ${INFERRED_COMPLEXITY}

user_specified:
  compliance: []
  human_review_level: moderate

_meta:
  detected_at: $(date -Iseconds)
  detection_confidence: ${DETECTION_CONFIDENCE}
  questions_asked: 0
  questions_auto_answered: $DETECTIONS_SUCCESS
  needs_user_input:
    language: ${NEEDS_USER_INPUT_LANGUAGE:-false}
    project_type: ${NEEDS_USER_INPUT_TYPE:-false}

PROFILE_EOF

echo ""
echo "âœ… Project profile saved to: geist/config/project-profile.yml"
```

### Step 6: Output Detection Summary

```bash
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  DETECTION COMPLETE"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "Detected Configuration:"
echo ""
echo "  Project Type:    ${DETECTED_PROJECT_TYPE:-unknown}"
echo "  Language:        ${DETECTED_LANGUAGE:-unknown}"
echo "  Framework:       ${DETECTED_FRAMEWORK:-(none detected)}"
echo "  Database:        ${DETECTED_DATABASE:-(none detected)}"
echo "  Size:            ${DETECTED_FILE_COUNT:-?} files, ~${DETECTED_LINE_COUNT:-?} lines"
echo "  Security Level:  ${DETECTED_SECURITY_LEVEL:-moderate}"
echo "  Complexity:      ${INFERRED_COMPLEXITY}"
echo ""
echo "  Build Command:   ${DETECTED_BUILD_CMD:-(not set)}"
echo "  Test Command:    ${DETECTED_TEST_CMD:-(not set)}"
echo "  Lint Command:    ${DETECTED_LINT_CMD:-(not set)}"
echo ""
echo "  Confidence:      ${DETECTION_CONFIDENCE}"
echo ""
```

---

## Integration

This workflow is called by:
- `adapt-to-product/1-setup-and-information-gathering.md`
- `create-basepoints/1-validate-prerequisites.md`
- `deploy-agents/1-validate-prerequisites.md`

After this workflow completes, call:
- `{{workflows/detection/present-and-confirm}}` - To get user confirmation
- `{{workflows/research/research-orchestrator}}` - To enrich with web research

---

## Important Constraints

- Must handle missing files gracefully (no errors)
- Must provide sensible defaults when detection fails
- Must flag low-confidence detections for user questions
- Must be idempotent (can run multiple times safely)
